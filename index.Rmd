--- 
title: "Análisis del COVID-19 en México"
author: |
  <a href=http://cristianoliva88.github.io/website> Cristian Oliva Avilés </a>
date: "Última actualización: `r format(Sys.Date(), '%b %d %Y')`"
site: bookdown::bookdown_site
output: bookdown::gitbook
documentclass: book
bibliography: [book.bib, packages.bib]
biblio-style: apalike
link-citations: yes
fontsize: 11pt
#graphics: yes
#github-repo: rstudio/bookdown-demo
#description: "Analisis COVID"
---

```{r loadlibraries, include = FALSE}
library(dplyr)
library(tidyverse)
library(readxl)
library(knitr)
library(plotly)
library(stringr)

knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE, echo = FALSE, 
                      results = 'asis', purl = FALSE)

#### FUNCTION TO REPLACE VALUES
vrepl <- function(x, list, values){
        out <- x
        j <- 1
          for(i in list){
            out <- replace(out, x==i, values[j])
            j <- j+1
          }
        out
      }

```

# Intro 

Este sitio web tiene el objetivo de brindar un fácil acceso a la información de los casos de COVID-19 en México, tanto a nivel federal como estatal. La fuente de estos datos son los [Datos Abiertos](https://www.gob.mx/salud/documentos/datos-abiertos-152127?idiom=es) puestos a disposición de la población en general por la Dirección General de Epidemiología de la Secretaría de Salud de México.

Intentaré actualizar este sitio web diariamente, usando datos actualizados y agregando nuevas gráficas y tablas.

Y recuerda, **¡si tu puedes, quédate en casa!**


```{r readcleandata}
##### FIRST, READ DATA FILE WITH ALL CASES
dta <- read_csv("Data/200415COVID19MEXICO.csv")

## Create variable to define MUNICIPIOS
dta <-  dta %>% mutate("MUNICIPIO_RES" = paste(`MUNICIPIO_RES`,
                                                  `ENTIDAD_RES`,
                                                  sep=".") )


filenm.catalogs <- "Data/Catalogos_0412.xlsx"
sheetnames <- excel_sheets(filenm.catalogs)

## Replace values of ORIGEN
dta.origen <- read_excel(filenm.catalogs, "Catálogo ORIGEN")
dta <- dta %>% mutate("ORIGEN" = vrepl(`ORIGEN`, dta.origen$CLAVE,
                                       dta.origen$DESCRIPCIÓN) )

## Replace values of SECTOR
dta.sector <- read_excel(filenm.catalogs, "Catálogo SECTOR")
dta <- dta %>% mutate("SECTOR" = vrepl(`SECTOR`, dta.sector$CLAVE,
                                       dta.sector$DESCRIPCIÓN) )

## Replace values of SEXO
dta.sexo <- read_excel(filenm.catalogs, "Catálogo SEXO")
dta <- dta %>% mutate("SEXO" = vrepl(`SEXO`, dta.sexo$CLAVE,
                                       dta.sexo$DESCRIPCIÓN) )

## Replace values of TIPO_PACIENTE
dta.tipo_paciente <- read_excel(filenm.catalogs, "Catálogo TIPO_PACIENTE")
dta <- dta %>% mutate("TIPO_PACIENTE" = vrepl(`TIPO_PACIENTE`,
                                        dta.tipo_paciente$CLAVE,
                                        dta.tipo_paciente$DESCRIPCIÓN) )

## Replace values of NACIONALIDAD
dta.nacionalidad <- read_excel(filenm.catalogs, "Catálogo NACIONALIDAD")
dta <- dta %>% mutate("NACIONALIDAD" = vrepl(`NACIONALIDAD`,
                                        dta.nacionalidad$CLAVE,
                                        dta.nacionalidad$DESCRIPCIÓN) )

## Replace values of RESULTADO
dta.resultado <- read_excel(filenm.catalogs, "Catálogo RESULTADO")
dta <- dta %>% mutate("RESULTADO" = vrepl(`RESULTADO`,
                                        dta.resultado$CLAVE,
                                        dta.resultado$DESCRIPCIÓN) )

## Replace values of ENTIDADES
dta.entidades <- read_excel(filenm.catalogs, "Catálogo de ENTIDADES")
for(x in c("ENTIDAD_UM","ENTIDAD_NAC", "ENTIDAD_RES")){
  dta[[x]] <- vrepl(dta[[x]], dta.entidades$CLAVE_ENTIDAD,
                                    dta.entidades$ENTIDAD_FEDERATIVA) 
  dta[[x]] <- str_to_title(dta[[x]])
}

## Replace values of MUNICIPIO_RES
dta.municipio_res <- read_excel(filenm.catalogs, "Catálogo MUNICIPIOS")
dta.municipio_res <- dta.municipio_res %>% 
                      mutate("ID_MUNICIPIO_RES" = paste(`CLAVE_MUNICIPIO`,
                                                  `CLAVE_ENTIDAD`, sep = "."))
x<- "MUNICIPIO_RES"
dta[[x]] <- vrepl(dta[[x]], dta.municipio_res$ID_MUNICIPIO_RES,
                                  dta.municipio_res$MUNICIPIO) 
dta[[x]] <- str_to_title(dta[[x]])

## Replace values of SI_NO variables
dta.si_no <- read_excel(filenm.catalogs, "Catálogo SI_NO")
for(x in c("INTUBADO", "NEUMONIA", "EMBARAZO", "HABLA_LENGUA_INDI",
           "DIABETES", "EPOC", "ASMA", "INMUSUPR", "HIPERTENSION",
           "OTRA_CON", "CARDIOVASCULAR", "OBESIDAD", "RENAL_CRONICA",
           "TABAQUISMO", "OTRO_CASO")){
  dta[[x]] <- vrepl(dta[[x]], dta.si_no$CLAVE,
                                    dta.si_no$DESCRIPCIÓN) 
}



#### CREATE GROUPS FOR WHICH SIMILAR ANALYSIS
#### WILL BE PERFORMED
dta1 <- dta %>% mutate(grp = `ENTIDAD_RES`)
dta0 <- dta1 %>% mutate(grp = "Nacional") 
dta_comb <- rbind(dta1, dta0)
dta_comb[["grp"]] <- as.factor(dta_comb[["grp"]])

## Split by grp
dta_split <- with(dta_comb, split(dta_comb, grp, drop = TRUE))
grp_names <- names(dta_split)

```

```{r analysisbygrp}
#### ANALYSIS BY GRP
date.first <- head(sort(unique(dta$FECHA_INGRESO)),1)
date.last <- tail(sort(unique(dta$FECHA_INGRESO)),1)
dta.blank <- data.frame("FECHA_INGRESO" = seq(date.first, date.last, 1))

tbl.pais <- NULL
tbl.entidades <- NULL
tbl.resultado <- NULL
tbl.municipios <- NULL

plot.posnew <- NULL
plot.postotal <- NULL
plot.sospnew <- NULL
plot.sosptotal <- NULL


#### FOR TABLES OF CASOS EN PAIS MEXICO
tbl.pais[["Nacional"]] <- dta_split[["Nacional"]]  %>% 
                summarise("Positivo" = sum(`RESULTADO` == "Positivo SARS-CoV-2"),
                "No Positivo" = sum(`RESULTADO` == "No positivo SARS-CoV-2"),
                "Sospechosos" = sum(`RESULTADO` == "Resultado pendiente"),
                "Decesos" = sum(!is.na(`FECHA_DEF`) & 
                                  `RESULTADO` == "Positivo SARS-CoV-2"))


#### FOR TABLES OF CASOS EN ENTIDADES
tbl.entidades[["Nacional"]] <- dta_split[["Nacional"]]  %>% 
                      group_by(`ENTIDAD_RES`) %>%
                summarise("Positivo" = sum(`RESULTADO` == "Positivo SARS-CoV-2"),
                "No Positivo" = sum(`RESULTADO` == "No positivo SARS-CoV-2"),
                "Sospechosos" = sum(`RESULTADO` == "Resultado pendiente"),
                "Decesos" = sum(!is.na(`FECHA_DEF`) & 
                                  `RESULTADO` == "Positivo SARS-CoV-2")) %>%
                  rename('Entidad Residencia' = ENTIDAD_RES)
  
#### START LOOP  
for(x in grp_names){
  dtagrp <- dta_split[[x]]
  
  #### FOR PLOTS OF POSITIVOS y PENDIENTES
  ans.tmp <- dtagrp %>% group_by(`FECHA_INGRESO`) %>%
      summarise("Nuevos Positivo" = sum(`RESULTADO` == "Positivo SARS-CoV-2"),
                "Nuevos No Positivo" = sum(`RESULTADO` == "No positivo SARS-CoV-2"),
                "Sospechosos" = sum(`RESULTADO` == "Resultado pendiente"),
                "Nuevos Decesos" = sum(!is.na(`FECHA_DEF`) & 
                                  `RESULTADO` == "Positivo SARS-CoV-2")) %>%
      mutate("Total Positivo" = cumsum(`Nuevos Positivo`),
              "Total No Positivo" = cumsum(`Nuevos No Positivo`),
              "Total Sospechosos" = cumsum(`Sospechosos`),
              "Total Decesos" = cumsum(`Nuevos Decesos`))
  ans.tmp <- left_join(dta.blank, ans.tmp, by="FECHA_INGRESO")
  ans.tmp[is.na(ans.tmp)] <- 0
  tbl.resultado[[x]] <- ans.tmp
  
  #### FOR JOINT GRAPHS
  tbl.res <- tbl.resultado[[x]] %>% gather(Tipo, Cantidad, 
                                        "Nuevos Positivo":"Total Decesos",
                                        factor_key = T)
  
  #### FOR TABLES OF CASOS EN MUNICIPIOS
  tbl.municipios[[x]] <- dtagrp  %>% group_by(`MUNICIPIO_RES`) %>%
                     summarise("Positivo" = 
                                 sum(`RESULTADO` == "Positivo SARS-CoV-2"),
                "No Positivo" = sum(`RESULTADO` == "No positivo SARS-CoV-2"),
                "Sospechosos" = sum(`RESULTADO` == "Resultado pendiente"),
                "Decesos" = sum(!is.na(`FECHA_DEF`) & 
                                  `RESULTADO` == "Positivo SARS-CoV-2")) %>%
                  rename('Municipio Residencia' = MUNICIPIO_RES)
  
  
  ## Make Plot of New Positive Cases
  plot.posnew[[x]] <- tbl.res %>% filter(`Tipo` %in% 
                               c("Nuevos Positivo", "Nuevos Decesos")) %>%
                      ggplot(aes(x = `FECHA_INGRESO`, y = `Cantidad`,
                                 grp = `Tipo`, color = `Tipo`)) +
                        geom_line() + 
                        geom_point(aes(text = paste(`Cantidad`, 
                               `Tipo`, 'en',
                              format(`FECHA_INGRESO`, "%d/%m")))) + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        scale_color_manual(values = c("darkblue", "red")) + 
                        xlab("Fecha de Ingreso/Fecha de Muerte") + 
                        ylab("Nuevos Casos Positivos y Decesos") 
  
  ## Make Plot of Total Positive Cases
    plot.postotal[[x]] <- tbl.res %>% filter(`Tipo` %in% 
                               c("Total Positivo", "Total Decesos")) %>%
                      ggplot(aes(x = `FECHA_INGRESO`, y = `Cantidad`,
                                 grp = `Tipo`, color = `Tipo`)) +
                        geom_line() + 
                        geom_point(aes(text = paste(`Cantidad`, 
                               `Tipo`, 'en',
                              format(`FECHA_INGRESO`, "%d/%m")))) + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        scale_color_manual(values = c("darkblue", "red")) + 
                        xlab("Fecha de Ingreso/Fecha de Muerte") + 
                        ylab("Total Casos Positivos y Decesos") 
    
    
  ## Make Plot of Suspect Cases by Day
  plot.sospnew[[x]] <- tbl.res %>% filter(`Tipo` %in% 
                               c("Sospechosos", "Nuevos Positivo")) %>%
                      ggplot(aes(x = `FECHA_INGRESO`, y = `Cantidad`,
                                 grp = `Tipo`, color = `Tipo`)) +
                        geom_line() + 
                        geom_point(aes(text = paste(`Cantidad`, 
                               `Tipo`, 'en',
                              format(`FECHA_INGRESO`, "%d/%m")))) + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        scale_color_manual(values = c("darkblue", "yellow4")) + 
                        xlab("Fecha de Ingreso") + 
                        ylab("Nuevos Casos Sospechosos y Positivos") 
    
  
  ## Make Plot of Total Suspect Cases
    plot.sosptotal[[x]] <- tbl.res %>% filter(`Tipo` %in% 
                               c("Total Sospechosos", "Total Positivo")) %>%
                      ggplot(aes(x = `FECHA_INGRESO`, y = `Cantidad`,
                                 grp = `Tipo`, color = `Tipo`)) +
                        geom_line() + 
                        geom_point(aes(text = paste(`Cantidad`, 
                               `Tipo`, 'en',
                              format(`FECHA_INGRESO`, "%d/%m")))) + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        scale_color_manual(values = c("darkblue", "yellow4")) + 
                        xlab("Fecha de Ingreso") + 
                        ylab("Total Casos Sospechosos y Positivos")  
                            
                        

  }


```

