--- 
title: "Análisis de Casos de COVID-19 en México"
author: |
  <a href=http://cristianoliva88.github.io/website> Cristian Oliva Avilés </a>
date: "Última actualización: `r format(Sys.Date(), '%b %d %Y')`"
site: bookdown::bookdown_site
output: bookdown::gitbook
documentclass: book
bibliography: [book.bib, packages.bib]
biblio-style: apalike
link-citations: yes
fontsize: 11pt
#graphics: yes
#github-repo: rstudio/bookdown-demo
description: "Análisis en Tiempo Real de Casos de COVID-19 en México con base en los Datos Abiertos de la Secretaría de Salud. El COVID-19 es la enfermedad causada por el nuevo coronavirus SARS-CoV-2. Autor: Cristian Oliva Avilés"
url: 'https\://casoscovidmx.com/'
favicon: "coronapic.png"
cover-image: images/tasaincidencia2.png
apple-touch-icon: "coronapic.png"
apple-touch-icon-size: 120
---

```{r loadlibraries, include = FALSE}
library(dplyr)
library(tidyverse)
library(readxl)
library(knitr)
library(plotly)
library(stringr)
library(RColorBrewer)


knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE, echo = FALSE, 
                      results = 'asis', 
                      purl = FALSE)

#### FUNCTION TO REPLACE VALUES
vrepl <- function(x, list, values){
        out <- x
        j <- 1
          for(i in list){
            out <- replace(out, x==i, values[j])
            j <- j+1
          }
        out
      }

```

# Intro 

```{r fig.align='center', echo=FALSE, out.width = "12.5%"}
knitr::include_graphics('coronapic.png', dpi = NA)
```

Este sitio web fue creado con el objetivo de brindar un fácil acceso a la información de los casos de COVID-19 en México, tanto a nivel federal como estatal. La fuente de estos datos son los [Datos Abiertos](https://www.gob.mx/salud/documentos/datos-abiertos-152127?idiom=es) puestos a disposición de la población en general por la Dirección General de Epidemiología de la Secretaría de Salud de México.

A partir de Septiembre, estaré actualizando este sitio cada domingo.

Recuerda, **¡si puedes, quédate en casa!**

*Créditos a [Diana Vega](https://www.instagram.com/shuguitubbie_art) (Shugui) por el diseño del Favicon*


```{r readcleandata}
##### FIRST, READ DATA FILE WITH ALL CASES
dta <- read_csv("Data/201219COVID19MEXICO.csv")
  
## Create variable to define MUNICIPIOS
dta <-  dta %>% mutate("MUNICIPIO_RES" = paste(`MUNICIPIO_RES`,
                                                  `ENTIDAD_RES`,
                                                  sep=".") )


filenm.catalogs <- "Data/Catalogos_0412.xlsx"
sheetnames <- excel_sheets(filenm.catalogs)

## Replace values of ORIGEN
dta.origen <- read_excel(filenm.catalogs, "Catálogo ORIGEN")
dta <- dta %>% mutate("ORIGEN" = vrepl(`ORIGEN`, dta.origen$CLAVE,
                                       dta.origen$DESCRIPCIÓN) )

## Replace values of SECTOR
dta.sector <- read_excel(filenm.catalogs, "Catálogo SECTOR")
dta <- dta %>% mutate("SECTOR" = vrepl(`SECTOR`, dta.sector$CLAVE,
                                       dta.sector$DESCRIPCIÓN) )

## Replace values of SEXO
dta.sexo <- read_excel(filenm.catalogs, "Catálogo SEXO")
dta <- dta %>% mutate("SEXO" = vrepl(`SEXO`, dta.sexo$CLAVE,
                                       dta.sexo$DESCRIPCIÓN),
                      "SEXO" = factor(`SEXO`, levels = c("MUJER",
                                                         "HOMBRE")))

## Replace values of TIPO_PACIENTE
dta.tipo_paciente <- read_excel(filenm.catalogs, "Catálogo TIPO_PACIENTE")
dta <- dta %>% mutate("TIPO_PACIENTE" = vrepl(`TIPO_PACIENTE`,
                                        dta.tipo_paciente$CLAVE,
                                        dta.tipo_paciente$DESCRIPCIÓN) )

## Replace values of NACIONALIDAD
dta.nacionalidad <- read_excel(filenm.catalogs, "Catálogo NACIONALIDAD")
dta <- dta %>% mutate("NACIONALIDAD" = vrepl(`NACIONALIDAD`,
                                        dta.nacionalidad$CLAVE,
                                        dta.nacionalidad$DESCRIPCIÓN) )

## Replace values of RESULTADO
dta.resultado <- read_excel(filenm.catalogs, "Catálogo RESULTADO")
dta <- dta %>% mutate("RESULTADO" = vrepl(`RESULTADO_LAB`,
                                        dta.resultado$CLAVE,
                                        dta.resultado$DESCRIPCIÓN) )

## Replace values of ENTIDADES
dta.entidades <- read_excel(filenm.catalogs, "Catálogo de ENTIDADES")
for(x in c("ENTIDAD_UM","ENTIDAD_NAC", "ENTIDAD_RES")){
  dta[[x]] <- vrepl(dta[[x]], dta.entidades$CLAVE_ENTIDAD,
                                    dta.entidades$ENTIDAD_FEDERATIVA) 
  dta[[x]] <- str_to_title(dta[[x]])
}

## Replace values of MUNICIPIO_RES
dta.municipio_res <- read_excel(filenm.catalogs, "Catálogo MUNICIPIOS")
dta.municipio_res <- dta.municipio_res %>% 
                      mutate("ID_MUNICIPIO_RES" = paste(`CLAVE_MUNICIPIO`,
                                                  `CLAVE_ENTIDAD`, sep = "."))
x<- "MUNICIPIO_RES"
dta[[x]] <- vrepl(dta[[x]], dta.municipio_res$ID_MUNICIPIO_RES,
                                  dta.municipio_res$MUNICIPIO) 
dta[[x]] <- str_to_title(dta[[x]])

## Replace values of SI_NO variables
dta.si_no <- read_excel(filenm.catalogs, "Catálogo SI_NO")
for(x in c("INTUBADO", "NEUMONIA", "EMBARAZO", "HABLA_LENGUA_INDIG",
           "DIABETES", "EPOC", "ASMA", "INMUSUPR", "HIPERTENSION",
           "OTRA_COM", "CARDIOVASCULAR", "OBESIDAD", "RENAL_CRONICA",
           "TABAQUISMO", "OTRO_CASO", "UCI")){
  dta[[x]] <- vrepl(dta[[x]], dta.si_no$CLAVE,
                                    dta.si_no$DESCRIPCIÓN) 
  dta[[x]] <- factor(dta[[x]], levels = c("SI","NO", "NO APLICA",
                                          "SE IGNORA", "NO ESPECIFICADO"))
}

## Create age group variable (10-year groups)
dta <- dta %>% mutate("EDAD_GRUPO" = 
                        findInterval(`EDAD`, c(10,20,30,40,50,60)),
                      "EDAD_GRUPO" = vrepl(`EDAD_GRUPO`,
                                           0:6, c("0-9","10-19","20-29",
                                                  "30-39","40-49","50-59",
                                                  ">=60")),
                      "EDAD_GRUPO" = factor(`EDAD_GRUPO`, 
                                            levels = c("0-9","10-19","20-29",
                                                  "30-39","40-49","50-59",
                                                  ">=60")) 
                      )


#### ADD STATE POPULATION
poblstate <- data.frame("grp" = c("Nacional",
                                          sort(unique(dta$`ENTIDAD_RES`))),
                        "POBLACION_ENT" = 
                          c(127792286,
                            1434635, 3634868, 804708, 1000617,
                            5730367, 3801487, 9018645, 3218720, 
                            785153, 1868996, 6228175, 3657048, 
                            3086414, 8409693, 17427790, 4825401,
                            2044058, 1288571, 5610153, 4143593, 
                            6604451, 2279637, 1723259,2866142, 
                            3156674, 3074745, 2572287, 3650602,
                            1380011, 8539862, 2259098,1666426)/100000
)

#### CREATE GROUPS FOR WHICH SIMILAR ANALYSIS
#### WILL BE PERFORMED
dta1 <- dta %>% mutate(grp = `ENTIDAD_RES`)
dta0 <- dta1 %>% mutate(grp = "Nacional") 
dta_comb <- rbind(dta1, dta0)
dta_comb[["grp"]] <- as.factor(dta_comb[["grp"]])
dta_comb <- left_join(dta_comb, poblstate, by = "grp")

## Split by grp
dta_split <- with(dta_comb, split(dta_comb, grp, drop = TRUE))
grp_names <- names(dta_split)

```

```{r analysisbygrp}
#### ANALYSIS BY GRP
date.first <- head(sort(unique(dta$FECHA_SINTOMAS)),1)
date.last <- tail(sort(unique(dta$FECHA_SINTOMAS)),1)
dta.blank <- data.frame("FECHA_SINTOMAS" = seq(date.first, date.last, 1))
dta.blank.compstate <- expand.grid("FECHA_SINTOMAS" = dta.blank$FECHA_SINTOMAS,
                                   "grp" = sort(unique(dta_comb$grp)))

tbl.nuevosdece <- NULL
tbl.nuevosdeceall <- NULL
tbl.pais <- NULL
tbl.entidades <- NULL
tbl.resultado <- NULL
tbl.municipios <- NULL
tbl.tasa <- NULL
tbl.percintub <- NULL
tbl.perchospcomorb <- NULL
tbl.percintubcomorb <- NULL

plot.casesnew <- NULL
plot.casestotal <- NULL
plot.pruebasnew <- NULL
plot.pospen <- NULL
plot.tasatotal <- NULL
plot.sector <- NULL
plot.possex <- NULL
plot.decesex <- NULL
plot.condicion <- NULL
plot.intub <- NULL
plot.time2death <- NULL
plot.poscompstate <- NULL
plot.poscompstatetasa <- NULL
plot.pendcompstate <- NULL
plot.dececompstate <- NULL
plot.actcompstate <- NULL
plot.actcompstatetasa <- NULL
plot.hospitedadsex <- NULL
plot.neumonia <- NULL
plot.intubdeath <- NULL
plot.comorbdeath <- NULL
plot.hospcomorb <- NULL
plot.intubcomorb <- NULL


#### TO COMPUTE NUMBER OF DEATHS BASED ON FECHA_DEF
for(x in grp_names){
  tbl.nuevosdece[[x]] <- dta_comb %>% filter(`grp` == x & !is.na(`FECHA_DEF`) & 
                              `RESULTADO` == "Positivo SARS-CoV-2") %>%
          group_by(`FECHA_DEF`) %>%
          summarise("grp" = x,
            "Nuevos Decesos" = n()) %>% rename("FECHA_SINTOMAS" = `FECHA_DEF`)
  tbl.nuevosdeceall <- rbind(tbl.nuevosdeceall, tbl.nuevosdece[[x]])
}

#### FUNCTION TO COMPUTE ACTIVE CASES
active.f <- function(x){
    n <- length(x)
    out <- NULL
    for(i in 1:n){
    k<- min(i,14) 
    out <- c(out, sum(x[(i-k+1):i]))
    }
    out
}

#### FOR TABLES OF CASOS EN PAIS MEXICO
tbl.pais[["Nacional"]] <- dta_split[["Nacional"]]  %>% 
                summarise("Positivo" = sum(`RESULTADO` == "Positivo SARS-CoV-2"),
                "No Positivo" = sum(`RESULTADO` == "No positivo SARS-CoV-2"),
                "Pendientes" = sum(`RESULTADO` == "Resultado pendiente"),
                "Decesos" = sum(!is.na(`FECHA_DEF`) & 
                                  `RESULTADO` == "Positivo SARS-CoV-2"))


#### FOR TABLES OF CASOS EN ENTIDADES
tbl.entidades[["Nacional"]] <- dta_split[["Nacional"]]  %>% 
                      group_by(`ENTIDAD_RES`) %>%
                summarise("Positivo" = sum(`RESULTADO` == "Positivo SARS-CoV-2"),
                "No Positivo" = sum(`RESULTADO` == "No positivo SARS-CoV-2"),
                "Pendientes" = sum(`RESULTADO` == "Resultado pendiente"),
                "Decesos" = sum(!is.na(`FECHA_DEF`) & 
                                  `RESULTADO` == "Positivo SARS-CoV-2")) %>%
                  rename('Entidad Residencia' = ENTIDAD_RES)

#### GRAPH FOR TREND BY STATE
tbl.compstatetmp <- dta_comb %>% 
                group_by(`grp`, `FECHA_SINTOMAS`) %>%
                summarise("Nuevos Positivo" = sum(`RESULTADO` == 
                                                    "Positivo SARS-CoV-2"),
                "Nuevos No Positivo" = sum(`RESULTADO` == 
                                             "No positivo SARS-CoV-2"),
                "Pendientes" = sum(`RESULTADO` == "Resultado pendiente"),
                "Nuevos Activos" = sum(`RESULTADO` ==  "Positivo SARS-CoV-2" #&
                                         #is.na(`FECHA_DEF`) ))
                ))
tbl.compstatetmp <- left_join(dta.blank.compstate, tbl.compstatetmp,
                                       by=c("grp", "FECHA_SINTOMAS")) %>%
                    left_join(tbl.nuevosdeceall,
                                       by=c("grp", "FECHA_SINTOMAS")) %>%
                    left_join(poblstate, by = "grp")
tbl.compstatetmp[is.na(tbl.compstatetmp)] <- 0

tbl.compstatetmp <- tbl.compstatetmp %>% group_by(`grp`) %>%
        mutate("Total Positivo" = cumsum(`Nuevos Positivo`),
              "Total No Positivo" = cumsum(`Nuevos No Positivo`),
              "Total Pendientes" = cumsum(`Pendientes`),
              "Total Decesos" = cumsum(`Nuevos Decesos`),
              "Tasa Positivo" = round(`Total Positivo`/`POBLACION_ENT`, 2),
              "Total Activos" = active.f(`Nuevos Activos`), 
              "Tasa Activos" = round(`Total Activos`/`POBLACION_ENT`,2))
        
tbl.compstatetmp <- tbl.compstatetmp %>% filter(`FECHA_SINTOMAS` >= "2020-03-01")

numcolors <- 33
mycolors <- colorRampPalette(brewer.pal(8, "Set1"))(numcolors)

plot.poscompstate[["Nacional"]] <- tbl.compstatetmp %>%
                      ggplot(aes(x = `FECHA_SINTOMAS`, y = `Total Positivo`,
                                 grp = `grp`, color = `grp`)) +
                        geom_line() +
                        geom_point(aes(text = paste(`Total Positivo`, 
                               'casos positivos en', `grp`, 'hasta',
                              format(`FECHA_SINTOMAS`, "%d/%m")))) + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        scale_color_manual(values = mycolors) + 
                        xlab("Fecha de Inicio Síntomas") + 
                        ylab("Total Casos Positivos") 

plot.actcompstate[["Nacional"]] <- tbl.compstatetmp %>%
                      ggplot(aes(x = `FECHA_SINTOMAS`, y = `Total Activos`,
                                 grp = `grp`, color = `grp`)) +
                        geom_line() +
                        geom_point(aes(text = paste(`Total Activos`, 
                               'casos activos en', `grp`, 'hasta',
                              format(`FECHA_SINTOMAS`, "%d/%m")))) + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        scale_color_manual(values = mycolors) + 
                        xlab("Fecha") + 
                        ylab("Total Casos Activos")

plot.actcompstatetasa[["Nacional"]] <- tbl.compstatetmp %>%
                      ggplot(aes(x = `FECHA_SINTOMAS`, y = `Tasa Activos`,
                                 grp = `grp`, color = `grp`)) +
                        geom_line() +
                        geom_point(aes(text = paste(`Tasa Activos`, 
                               'tasa de incidencia en', `grp`, 'hasta',
                              format(`FECHA_SINTOMAS`, "%d/%m")))) + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        scale_color_manual(values = mycolors) + 
                        xlab("Fecha") + 
                        ylab("Tasa Casos Activos")

plot.pendcompstate[["Nacional"]] <- tbl.compstatetmp %>%
                      ggplot(aes(x = `FECHA_SINTOMAS`, y = `Total Pendientes`,
                                 grp = `grp`, color = `grp`)) +
                        geom_line() +
                        geom_point(aes(text = paste(`Total Pendientes`, 
                               'tasa de incidencia en', `grp`, 'hasta',
                              format(`FECHA_SINTOMAS`, "%d/%m")))) + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        scale_color_manual(values = mycolors) + 
                        xlab("Fecha de Inicio Síntomas") + 
                        ylab("Total Casos Pendientes") 

plot.dececompstate[["Nacional"]] <- tbl.compstatetmp %>%
                      ggplot(aes(x = `FECHA_SINTOMAS`, y = `Total Decesos`,
                                 grp = `grp`, color = `grp`)) +
                        geom_line() +
                        geom_point(aes(text = paste(`Total Decesos`, 
                               'decesos en', `grp`, 'hasta',
                              format(`FECHA_SINTOMAS`, "%d/%m")))) + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        scale_color_manual(values = mycolors) + 
                        xlab("Fecha de Fallecimiento") + 
                        ylab("Total Decesos") 

plot.poscompstatetasa[["Nacional"]] <- tbl.compstatetmp %>%
                      ggplot(aes(x = `FECHA_SINTOMAS`, y = `Tasa Positivo`,
                                 grp = `grp`, color = `grp`)) +
                        geom_line() +
                        geom_point(aes(text = paste(`Tasa Positivo`, 
                               ' tasa de incidencia en', `grp`, 'hasta',
                              format(`FECHA_SINTOMAS`, "%d/%m")))) + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        scale_color_manual(values = mycolors) + 
                        xlab("Fecha de Inicio Síntomas") + 
                        ylab("Tasa de Incidencia por cada 100mil habitantes") 

  
#### START LOOP  
for(x in grp_names){
  dtagrp <- dta_split[[x]]
  
  #### FOR TABLES OF CASOS EN MUNICIPIOS
  tbl.municipios[[x]] <- dtagrp  %>% group_by(`MUNICIPIO_RES`) %>%
                     summarise("Positivo" = 
                                 sum(`RESULTADO` == "Positivo SARS-CoV-2"),
                "No Positivo" = sum(`RESULTADO` == "No positivo SARS-CoV-2"),
                "Pendientes" = sum(`RESULTADO` == "Resultado pendiente"),
                "Decesos" = sum(!is.na(`FECHA_DEF`) & 
                                  `RESULTADO` == "Positivo SARS-CoV-2")) %>%
                  rename('Municipio Residencia' = MUNICIPIO_RES)
  
  #### FOR PLOTS OF POSITIVOS, PENDIENTES Y MUERTES
  ans.tmp <- dtagrp %>% group_by(`FECHA_SINTOMAS`) %>%
      summarise("Nuevos Positivo" = sum(`RESULTADO` == "Positivo SARS-CoV-2"),
                "Nuevos No Positivo" = sum(`RESULTADO` == "No positivo SARS-CoV-2"),
                "Pendientes" = sum(`RESULTADO` == "Resultado pendiente"))
  ans.tmp <- left_join(dta.blank, ans.tmp, by="FECHA_SINTOMAS") %>%
                left_join(tbl.nuevosdece[[x]] %>% 
                            dplyr::select(-c(`grp`)), by = "FECHA_SINTOMAS")
  ans.tmp[is.na(ans.tmp)] <- 0
  
  ans.tmp <- ans.tmp %>%  mutate("Total Positivo" = cumsum(`Nuevos Positivo`),
              "Total No Positivo" = cumsum(`Nuevos No Positivo`),
              "Total Pendientes" = cumsum(`Pendientes`),
              "Total Decesos" = cumsum(`Nuevos Decesos`))
  
  tbl.resultado[[x]] <- ans.tmp %>% filter(`FECHA_SINTOMAS` >= "2020-03-01")
  
  #### FOR JOINT GRAPHS OF CASES
  tbl.restmp <- tbl.resultado[[x]] %>% gather(Tipo, Cantidad, 
                                        "Nuevos Positivo":"Total Decesos",
                                        factor_key = T)
  
  ## Make Plot of New Positive Cases
  plot.casesnew[[x]] <- tbl.restmp %>% filter(`Tipo` %in% 
                               c("Nuevos Positivo", "Nuevos Decesos",
                                 "Pendientes")) %>%
                      ggplot(aes(x = `FECHA_SINTOMAS`, y = `Cantidad`,
                                 grp = `Tipo`, color = `Tipo`)) +
                        geom_line() + 
                        geom_point(aes(text = paste(`Cantidad`, 
                               `Tipo`, 'en',
                              format(`FECHA_SINTOMAS`, "%d/%m")))) + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        scale_color_manual(values = c("darkblue","yellow4",
                                                      "red")) + 
                        xlab("Fecha de Inicio Síntomas/Fecha de Deceso") + 
                        ylab("Nuevos Casos") 
  
  ## Make Plot of Total Positive Cases
    plot.casestotal[[x]] <- tbl.restmp %>% filter(`Tipo` %in% 
                               c("Total Positivo", "Total Decesos",
                                 "Total Pendientes")) %>%
                      ggplot(aes(x = `FECHA_SINTOMAS`, y = `Cantidad`,
                                 grp = `Tipo`, color = `Tipo`)) +
                        geom_line() + 
                        geom_point(aes(text = paste(`Cantidad`, 
                               `Tipo`, 'hasta',
                              format(`FECHA_SINTOMAS`, "%d/%m")))) + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        scale_color_manual(values = c("darkblue","yellow4",
                                                      "red")) + 
                        xlab("Fecha de Inicio Síntomas/Fecha de Deceso") + 
                        ylab("Total Casos") 
    
    ## Make Plot of Total + Suspects
    tbl.pospen <- tbl.resultado[[x]] %>% filter(`FECHA_SINTOMAS` <= Sys.Date() - 0 ) %>%
                gather(Tipo, Cantidad, "Nuevos Positivo":"Total Decesos",
                                          factor_key = T) %>%
                filter(`Tipo` %in% c("Nuevos Positivo", "Pendientes") )
    
    plot.pospen[[x]] <- tbl.pospen %>% ggplot(aes(x = `FECHA_SINTOMAS`, 
                                                 y = `Cantidad`
                                                # fill = `Tipo`
                                         )) +
                geom_col(position = position_stack(reverse = TRUE),
                # geom_bar(stat = "identity",  position = "stack",
                          aes(fill = `Tipo`, text = paste(`Cantidad`, 
                               `Tipo`, 'en',
                              format(`FECHA_SINTOMAS`, "%d/%m")))) +
                    #geom_point() + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        scale_fill_brewer(palette = "Dark2") +
                        xlab("Fecha Inicio Síntomas") + 
                        ylab("Número de Casos") 


    #### Make Plot for Pruebas/Casos por Dia
    ans.tmp2 <- dtagrp %>% group_by(`FECHA_INGRESO`) %>%
      summarise("Nuevos Positivo" = sum(`RESULTADO` == "Positivo SARS-CoV-2"),
                "Nuevos No Positivo" = sum(`RESULTADO` == "No positivo SARS-CoV-2"),
                "Pendientes" = sum(`RESULTADO` == "Resultado pendiente")) %>%
      mutate("Nuevas Pruebas" = `Nuevos Positivo` + `Nuevos No Positivo` +
                                       `Pendientes`)
    
    plot.pruebasnew[[x]] <- ans.tmp2 %>%
                      ggplot(aes(x = `FECHA_INGRESO`, y = `Nuevas Pruebas`)) +
                        geom_line(color = "darkblue") + 
                        geom_point(color = "darkblue",
                                   aes(text = paste(`Nuevas Pruebas`, 
                                'casos/pruebas en',
                              format(`FECHA_INGRESO`, "%d/%m")))) + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        xlab("Fecha de Ingreso") + 
                        ylab("Casos/Pruebas por Día") 
    
    
    #### FOR JOINT GRAPHS OF TASA
    pobstate.grp <- poblstate[which(poblstate$grp == x), "POBLACION_ENT"]
    tbl.tasa[[x]] <- tbl.resultado[[x]] %>% 
              mutate("Tasa Positividad por Dia" = `Nuevos Positivo`/
                              (`Nuevos Positivo` + `Nuevos No Positivo`),
                     "Tasa Positividad" = `Total Positivo`/
                              (`Total Positivo` + `Total No Positivo`),
                     "Tasa Letalidad por Dia" = `Nuevos Decesos`/
                              `Nuevos Positivo`,  
                      "Tasa Letalidad" = `Total Decesos`/
                              `Total Positivo`,
              "Tasa Mortalidad" = round(100*`Total Decesos`/(100000*pobstate.grp), 2))   
    
    tbl.tasatmp <- tbl.tasa[[x]] %>% 
                  gather(Tasa, Cantidad,  
                         "Tasa Positividad por Dia":"Tasa Mortalidad",
                                        factor_key = T)
  
    ## Make Plot of Tasa Positividad/Letalidad
    plot.tasatotal[[x]] <-  tbl.tasatmp %>%  filter(`Tasa` %in% 
                               c("Tasa Positividad", "Tasa Letalidad")) %>%
                            ggplot(aes(x = `FECHA_SINTOMAS`, y = `Cantidad`,
                                   grp = `Tasa`, color = `Tasa`)) +
                        geom_line() + 
                        geom_point(aes(text = paste(`Tasa`, 'es',
                                             round(100*`Cantidad`, 2), '% hasta',
                              format(`FECHA_SINTOMAS`, "%d/%m")))) + 
                        theme_bw() + 
                        theme(legend.title = element_blank()) +
                        scale_color_manual(values = c("darkblue","red", 
                                                      "orange")) + 
                        xlab("Fecha de Inicio Síntomas/Fecha de Deceso") + 
                        ylab("Tasa de Positividad y Letalidad") 
    
    
    #### FOR UNIDAD MEDICA THAT OFFERED HEALTH SERVICE
     tbl.sectortmp <- dtagrp %>% group_by(`SECTOR`) %>%
          summarise("Casos" = n()) %>%
          mutate("Porcentaje" = round(100*`Casos`/sum(`Casos`), 2) )
     
     plot.sector[[x]] <- tbl.sectortmp %>% ggplot(aes(x = `SECTOR`, 
                                                      y = `Casos`)) + 
                          geom_bar(stat = "identity", 
                                   aes(text = paste(`Casos`, 
                                                    " casos atendidos en ", 
                                                    `SECTOR`,
                                              " (", `Porcentaje`, "%)", sep="")), 
                                   fill = "darkblue") + 
                          theme_bw() + 
                          theme(axis.text.x = element_text(size = rel(0.8), 
                                                           angle = 45)) +
                          xlab("Institución que brindó la atención") + 
                          ylab("Número de Casos") 
     
     
    #### FOR STATS ON POSITIVE CASES BY EDAD/SEXO
    tbl.possextmp <- dtagrp %>% filter(`RESULTADO` == "Positivo SARS-CoV-2") %>%
          group_by(`EDAD_GRUPO`, `SEXO`, .drop = FALSE) %>%
            summarise("Casos" = n()) %>% ungroup() %>%
              mutate("Porcentaje" = round(100*`Casos`/sum(`Casos`), 2))
    
    plot.possex[[x]] <- tbl.possextmp %>% ggplot(aes(x = `EDAD_GRUPO`, 
                                                 y = `Casos`, 
                                                 fill = `SEXO`)) +
                  geom_bar(stat = "identity", 
                                   aes(text = paste(`Casos`, 
                                  " casos positivos entre ",  `EDAD_GRUPO`, 
                                  " años ","(", `Porcentaje`, "%)",
                                              sep=""))) +
                  theme_bw()  +
                  scale_fill_brewer(palette = "Dark2") +
                  xlab("Grupo de Edad") + 
                  ylab("Número de Casos Positivos") 
    
    #### FOR STATS ON POSITIVE HOSPITALIZED CASES BY EDAD/SEXO
    tbl.hospitedadsextmp <- dtagrp %>% filter(`RESULTADO` == "Positivo SARS-CoV-2" &
                                         `TIPO_PACIENTE` == "HOSPITALIZADO") %>%
          group_by(`EDAD_GRUPO`, `SEXO`, .drop = FALSE) %>%
            summarise("Casos" = n()) %>% ungroup() %>%
              mutate("Porcentaje" = round(100*`Casos`/sum(`Casos`), 2))
    
    plot.hospitedadsex[[x]] <- tbl.hospitedadsextmp %>% ggplot(aes(x = `EDAD_GRUPO`, 
                                                 y = `Casos`, 
                                                 fill = `SEXO`)) +
                  geom_bar(stat = "identity", 
                                   aes(text = paste(`Casos`, 
                                  " casos hospitalizados entre ",  `EDAD_GRUPO`, 
                                  " años ","(", `Porcentaje`, "%)",
                                              sep=""))) +
                  theme_bw()  +
                  scale_fill_brewer(palette = "Dark2") +
                  xlab("Grupo de Edad") + 
                  ylab("Número de Casos Hospitalizados") 
    
    
    #### FOR STATS ON POSITIVE CASES WITH NEUMONIA BY EDAD/SEXO
    tbl.neumoniatmp <- dtagrp %>% filter(`RESULTADO` == "Positivo SARS-CoV-2" &
                                         `NEUMONIA` == "SI") %>%
          group_by(`EDAD_GRUPO`, `SEXO`, .drop = FALSE) %>%
            summarise("Casos" = n()) %>% ungroup() %>%
              mutate("Porcentaje" = round(100*`Casos`/sum(`Casos`), 2))
    
    plot.neumonia[[x]] <- tbl.neumoniatmp %>% ggplot(aes(x = `EDAD_GRUPO`, 
                                                 y = `Casos`, 
                                                 fill = `SEXO`)) +
                  geom_bar(stat = "identity", 
                                   aes(text = paste(`Casos`, 
                                  " casos presentaron neumonia entre ",  `EDAD_GRUPO`, 
                                  " años ","(", `Porcentaje`, "%)",
                                              sep=""))) +
                  theme_bw()  +
                  scale_fill_brewer(palette = "Dark2") +
                  xlab("Grupo de Edad") + 
                  ylab("Número de Casos Hospitalizados") 
    

    #### FOR STATS ON DECESOS BY EDAD
    tbl.decesextmp <- dtagrp %>% filter(`RESULTADO` == "Positivo SARS-CoV-2" &
                                         !is.na(`FECHA_DEF`)) %>%
          group_by(`EDAD_GRUPO`, `SEXO`, .drop = FALSE) %>%
            summarise("Casos" = n()) %>% ungroup() %>%
              mutate("Porcentaje" = round(100*`Casos`/sum(`Casos`), 2))
    
    plot.decesex[[x]] <- tbl.decesextmp %>% ggplot(aes(x = `EDAD_GRUPO`, 
                                                 y = `Casos`, 
                                                 fill = `SEXO`)) +
                  geom_bar(stat = "identity", 
                                   aes(text = paste(`Casos`, 
                                  " decesos entre ",  `EDAD_GRUPO`, 
                                  " años ","(", `Porcentaje`, "%)",
                                              sep=""))) +
                  theme_bw()  +
                  scale_fill_brewer(palette = "Dark2") +
                  xlab("Grupo de Edad") + 
                  ylab("Número de Decesos") 
    
    
     #### MORTALITY BY MEDICAL CONDITION AND AGE GROUP
     tbl.condiciontmp <- dtagrp %>% filter(!is.na(`FECHA_DEF`) &
                                  `RESULTADO` == "Positivo SARS-CoV-2") %>%
                         gather(Condicion, SiNo, 
                                      "DIABETES":"TABAQUISMO", factor_key = T) %>%
                  mutate("SiNo" = as.factor(`SiNo`)) %>%
                  group_by(`Condicion`, `EDAD_GRUPO`, `SiNo`, .drop = FALSE) %>%
                        summarise("Casos" = n()) %>% ungroup() %>%
                        group_by(`Condicion`) %>%
                        mutate("Porcentaje" = round(100*`Casos`/sum(`Casos`) )) 
      
     plot.condicion[[x]] <- tbl.condiciontmp %>% filter(`SiNo` == "SI") %>%
                                  ggplot(aes(x = `EDAD_GRUPO`, 
                                                 y = `Porcentaje`)) +
                  geom_bar(stat = "identity", fill = "darkblue", 
                                   aes(text = paste(`Casos`, 
                                  " decesos con ",  `Condicion`, " entre ",
                                  `EDAD_GRUPO`, 
                                  " años ","(", `Porcentaje`, "%)",
                                              sep=""))) +
                  facet_wrap(~`Condicion`, ncol = 2) +
                  theme_bw()  +
                  theme(axis.text.x = element_text(size = rel(0.8), 
                                                           angle = 45),
                        strip.text.x = element_text(face = "bold",
                                                    size = rel(0.9)),
                        strip.background = element_rect(size=1)) +
                  scale_fill_brewer(palette = "Dark2") +
                  xlab("Grupo de Edad") + 
                  ylab("% de Decesos por Enfermedad")    
      
     
    #### INTUBADOS AND UCI
    tbl.intubtmp <- dtagrp %>% filter(`RESULTADO` == "Positivo SARS-CoV-2" &
                                        `TIPO_PACIENTE` == "HOSPITALIZADO" &
                                        `INTUBADO` %in% c("SI", "NO")) %>%
                      group_by(`INTUBADO`, `UCI`, .drop = TRUE) %>%
            summarise("Casos" = n()) %>% ungroup() %>%
              mutate("Porcentaje" = round(100*`Casos`/sum(`Casos`), 2))
    
    plot.intub[[x]] <- tbl.intubtmp %>% ggplot(aes(x = `INTUBADO`, 
                                                 y = `Casos`, 
                                                 fill = `UCI`)) +
                  geom_bar(stat = "identity", 
                                   aes(text = paste(`Casos`, 
                                  " casos ",  `INTUBADO`, " intubados",
                                  " y ", `UCI`, " en UCI (", `Porcentaje`, "%)",
                                              sep=""))) +
                  theme_bw() +
                  theme(legend.text = element_text(size = rel(0.7)),
                        axis.text.x = element_text(
                                        size = rel(0.8), angle = 45)) +
                  scale_fill_brewer(palette = "Dark2") +
                  xlab("¿INTUBADO?") + 
                  ylab("Número de Casos") 
    
    
    #### TO PERCENTAGE OF HOSPITALIZED CASES THAT HAVE DIED DEPENDING 
    #### ON WHETHER OR NOT THEY WERE INTUBATED
    tbl.intubdeathtmp <- dtagrp %>% filter(`RESULTADO` == "Positivo SARS-CoV-2" & 
                                          `TIPO_PACIENTE` == "HOSPITALIZADO") %>%
            group_by(`INTUBADO`) %>%
            summarise(
              "Porcentaje" = round(100*mean(!is.na(`FECHA_DEF`)), 2))
    
    plot.intubdeath[[x]] <- tbl.intubdeathtmp %>% ggplot(aes(x = `INTUBADO`, 
                                                 y = `Porcentaje`)) +
                  geom_bar(stat = "identity", fill = "darkblue",
                                   aes(text = paste(`Porcentaje`, 
                                  "% de casos hospitalizados ",  `INTUBADO`, " intubados han fallecido",
                                              sep=""))) +
                  theme_bw() +
                  theme(legend.text = element_text(size = rel(0.7)),
                        axis.text.x = element_text(
                                        size = rel(0.8), angle = 45)) +
                  scale_fill_brewer(palette = "Dark2") +
                  xlab("¿INTUBADO?") + 
                  ylab("% de Decesos según Intubación") 
    
    #### COMPUTE PERCENTAGE OF INTUBATED THAT HAVE BEEN HOSPITALIZED
    tbl.percintub[[x]] <- dtagrp %>% filter(`RESULTADO` == "Positivo SARS-CoV-2" & 
                                          `TIPO_PACIENTE` == "HOSPITALIZADO") %>%
                        summarise("Total.Hospi" = n(),
                                  "Total.Intub" = sum(`INTUBADO` == "SI"),
                                  "Perc.Intub" = round(100*`Total.Intub`/`Total.Hospi`, 2))
        
    #### TO EVALUATE TIME FROM FIRST SYMPTOMS TO DEATH
    tbl.time2deathtmp <- dtagrp %>% filter(`RESULTADO` == "Positivo SARS-CoV-2" & 
                                            !is.na(`FECHA_DEF`)) %>%
                          mutate("Diasparadeceso" = `FECHA_DEF` - `FECHA_SINTOMAS`) %>%
                          group_by(`Diasparadeceso`) %>%
                          summarise("Casos" = n()) %>%  ungroup() %>%
                    mutate("Porcentaje" = round(100*`Casos`/sum(`Casos`), 2))
    
    plot.time2death[[x]] <- tbl.time2deathtmp %>% ggplot(aes(x = `Diasparadeceso`,
                                                             y = `Casos`)) +
                  geom_bar(stat = "identity", fill = "darkblue",
                                 aes(text = paste(`Casos`, " fallecieron en ",`Diasparadeceso`, 
                                  " dias ", "(", `Porcentaje`, "%)", sep=""))) +
                  theme_bw() +
                  xlab("Días entre inicio de síntomas y deceso") + 
                  ylab("Número de Casos")
     
    
    #### TO EVALUATE NUMBER OF COMORBILITIES AND DEATH RISK
    tbl.comorbdeath <- dtagrp %>% filter(`RESULTADO` == "Positivo SARS-CoV-2") %>%
       mutate("FALLECIO" = ifelse(!is.na(`FECHA_DEF`), "Si", "No" ),
                             "TIEMPO_ATENCION" = `FECHA_INGRESO` - `FECHA_SINTOMAS`,
              "COMORB" =  paste(`DIABETES`, `EPOC`, `ASMA`, `INMUSUPR`, `HIPERTENSION`,
                                `OTRA_COM`, `CARDIOVASCULAR`, `OBESIDAD`, `RENAL_CRONICA`,
                                `TABAQUISMO`, sep="."),
              "COMORB2" = grepl("SI", `COMORB`),
              "COMORB3" = str_count(`COMORB`, "SI"))
        
    tbl.comorbdeath2 <- tbl.comorbdeath %>% filter(`TIPO_PACIENTE` == "HOSPITALIZADO") %>%
      mutate("COMORB_NUMB" = ifelse(`COMORB3`>=3, ">=3", `COMORB3`),
             "COMORB_NUMB" = factor(`COMORB_NUMB`, levels=c("0","1", "2",">=3"))) %>%
          group_by(`COMORB_NUMB`) %>%
          summarise("Porcentaje" =  round( 100*sum(!is.na(`FECHA_DEF`))/n(), 2))
    
    plot.comorbdeath[[x]] <- tbl.comorbdeath2 %>% ggplot(aes(x = `COMORB_NUMB`, 
                                                             y=`Porcentaje`)) + 
                geom_bar(stat = "identity", fill = "darkblue", 
                                   aes(text = paste(`Porcentaje`, 
                                  "% de los casos hospitalizados con ",  `COMORB_NUMB`, 
                                  " comorbilidades han fallecido",
                                              sep=""))) +
                  theme_bw() +
                  xlab("# de comorbilidades por paciente") + 
                  ylab("% de decesos que son \n COVID-19 positivos y hospitalizados") 
    
    
    #### TO BUILD GRAPHS OF HOSPITALIZED BY COMORBIDITIES
    tbl.hospcomorb <- dtagrp %>% filter(`RESULTADO` == "Positivo SARS-CoV-2" & 
                                          `TIPO_PACIENTE` == "HOSPITALIZADO") %>%
              gather("COMORB", "RESPUESTA", DIABETES:TABAQUISMO, factor_key = TRUE ) %>%
              group_by(`COMORB`) %>%
              summarise("Porcentaje" = round(100*mean(`RESPUESTA` == "SI"), 2),
                        "Casos" = sum(`RESPUESTA` == "SI")) %>%
              arrange(desc(`Porcentaje`))
    
    plot.hospcomorb[[x]] <- tbl.hospcomorb %>% ggplot(aes(x = reorder(`COMORB`, -`Porcentaje`), 
                                                             y=`Porcentaje`)) + 
                geom_bar(stat = "identity", fill = "darkblue", 
                                   aes(text = paste(`Porcentaje`, 
                                  "% de los casos hospitalizados tienen ",  `COMORB`, 
                                  "",
                                              sep=""))) + 
                  theme_bw() +
                  theme(legend.text = element_text(size = rel(0.7)),
                        axis.text.x = element_text(
                                        size = rel(0.7), angle = 45)) +
                  xlab("Comorbilidad") + 
                  ylab("% de hospitalizados por comorbilidad") 
    
    ## COMPUTE PERCENTAGE OF HOSPITALIZED WITH AT LEAST ONE COMORBILITY
    tbl.perchospcomorb[[x]] <- dtagrp %>% filter(`RESULTADO` == 
                                                               "Positivo SARS-CoV-2" & 
                                          `TIPO_PACIENTE` == "HOSPITALIZADO") %>%
            mutate("COMORB" =  paste(`DIABETES`, `EPOC`, `ASMA`, `INMUSUPR`, `HIPERTENSION`,
                                `OTRA_COM`, `CARDIOVASCULAR`, `OBESIDAD`, `RENAL_CRONICA`,
                                `TABAQUISMO`, sep="."),
              "COMORB2" = grepl("SI", `COMORB`),
              "COMORB3" = str_count(`COMORB`, "SI")) %>%
            summarise("Total" = n(),
                      "Casos" = sum(`COMORB3` >= 1),
                      "Porcentaje" = round(100*mean(`COMORB3` >= 1), 2))
    
    
    #### TO BUILD GRAPHS OF INTUBATED BY COMORBIDITIES
    tbl.intubcomorb <- dtagrp %>% filter(`RESULTADO` == "Positivo SARS-CoV-2" & 
                                          `TIPO_PACIENTE` == "HOSPITALIZADO" &
                                          `INTUBADO` == "SI") %>%
              gather("COMORB", "RESPUESTA", DIABETES:TABAQUISMO, factor_key = TRUE ) %>%
              group_by(`COMORB`) %>%
              summarise("Porcentaje" = round(100*mean(`RESPUESTA` == "SI"), 2),
                        "Casos" = sum(`RESPUESTA` == "SI")) %>%
              arrange(desc(`Porcentaje`))
    
    plot.intubcomorb[[x]] <- tbl.intubcomorb %>% ggplot(aes(x = reorder(`COMORB`, -`Porcentaje`), 
                                                             y=`Porcentaje`)) + 
                geom_bar(stat = "identity", fill = "darkblue", 
                                   aes(text = paste(`Porcentaje`, 
                                  "% de los casos intubados tienen ",  `COMORB`, 
                                  "",
                                              sep=""))) + 
                  theme_bw() +
                  theme(legend.text = element_text(size = rel(0.7)),
                        axis.text.x = element_text(
                                        size = rel(0.7), angle = 45)) +
                  xlab("Comorbilidad") + 
                  ylab("% de casos intubados por comorbilidad") 
    
    ## COMPUTE PERCENTAGE OF HOSPITALIZED WITH AT LEAST ONE COMORBILITY
    tbl.percintubcomorb[[x]] <- dtagrp %>% filter(`RESULTADO` == 
                                                               "Positivo SARS-CoV-2" & 
                                          `TIPO_PACIENTE` == "HOSPITALIZADO" &
                                            `INTUBADO` == "SI") %>%
            mutate("COMORB" =  paste(`DIABETES`, `EPOC`, `ASMA`, `INMUSUPR`, `HIPERTENSION`,
                                `OTRA_COM`, `CARDIOVASCULAR`, `OBESIDAD`, `RENAL_CRONICA`,
                                `TABAQUISMO`, sep="."),
              "COMORB2" = grepl("SI", `COMORB`),
              "COMORB3" = str_count(`COMORB`, "SI")) %>%
            summarise("Total" = n(),
                      "Casos" = sum(`COMORB3` >= 1),
                      "Porcentaje" = round(100*mean(`COMORB3` >= 1), 2))
    
    
  } ## end big loop
```

```{r eval=FALSE}
library(zoo)
pp <- tbl.kk %>% filter(`Tipo` == "Nuevos Positivo") %>% 
            filter(`FECHA_SINTOMAS` <= Sys.Date() - 7 ) %>%
            mutate(`Promedio Movil` = rollmean(`Cantidad`, k=5, fill=NA))
plot.pp <- pp %>% ggplot(aes(x = `FECHA_SINTOMAS`, 
                                                 y = `Promedio Movil`)) +
              geom_point() + geom_line() +
              ggtitle("Yucatán") +
                  theme_bw()  +
                  scale_fill_brewer(palette = "Dark2") +
                  xlab("Fecha Inicio Síntomas") + 
                  ylab("Promedio Movil: # de Casos Confirmados") 


#### Plot incidence rate with all states (smoothed)
library(zoo)
library(scales)

abbr <- c("AGU", "BCN", "BCS", "CAM", "CHP", "CHH", "CMX", "COA",
          "COL", "DUR", "GUA", "GRO", "HID", "JAL", "MEX", "MIC",
          "MOR", "MX", "NAY", "NLE", "OAX", "PUE", "QUE", "ROO", "SLP",
          "SIN", "SON", "TAB", "TAM", "TLA", "VER", "YUC", "ZAC")

tbl.kk <- tbl.compstatetmp %>% 
            filter(`FECHA_SINTOMAS` <= Sys.Date() - 7) %>%
            group_by(`grp`) %>%
            mutate("Promedio Movil Tasa Nuevos Positivos" = 
                    rollmean(`Nuevos Positivo`/`POBLACION_ENT`, k = 5, fill = NA),
                   "Tasa Pendientes" = `Pendientes`/`POBLACION_ENT`) %>%
            ungroup()

len <- dim(tbl.kk)[1]/33
tbl.kk <- tbl.kk %>% mutate(grp2 =  rep(abbr, each=len))

colors <- c("Nuevos Positivo" = "darkblue", "Pendientes" = "yellow4")
plot.kk <- tbl.kk %>% filter(grp != "Nacional") %>%
              ggplot(aes(x = `FECHA_SINTOMAS`)) +
              #geom_point() + 
              geom_line(aes(y = `Promedio Movil Tasa Nuevos Positivos`, 
                          color= "Nuevos Positivo")) + 
              geom_line(aes(y = `Tasa Pendientes`, color ="Pendientes")) +
              facet_wrap(~grp2, nrow=4) +
              ggtitle("Nuevos Casos Positivos COVID-19 en México") +
              scale_x_date(date_minor_breaks = "1 month") +
                  theme_bw() +
                  scale_fill_brewer(palette = "Dark2") +
                  xlab("Fecha de Inicio Síntomas") + 
                  ylab("# de Casos por cada 100k hab") +
              labs(color = "") + scale_color_manual(values = colors) +
              theme(legend.position = "bottom",
                    axis.text.x = element_text(size=7))


library(grid)
g <- grid.force(ggplotGrob(plot.kk))
# Get the names of grobs and their gPaths into a data.frame structure
grobs_df <- do.call(cbind.data.frame, grid.ls(g, print = FALSE))
# Build optimal gPaths that will be later used to identify grobs and edit them
grobs_df$gPath_full <- paste(grobs_df$gPath, grobs_df$name, sep = "::")
grobs_df$gPath_full <- gsub(pattern = "layout::", 
                            replacement = "", 
                            x = grobs_df$gPath_full, 
                            fixed = TRUE)
strip_bg_gpath <- grobs_df$gPath_full[grepl(pattern = ".*strip\\.background.*", 
                                            x = grobs_df$gPath_full)]
strip_bg_gpath[1] # example of a gPath for strip background 
n_cols <- length(strip_bg_gpath)
fills <- rep("white", 32) #rep(c(rep("seagreen",3), rep("white",2), rep("red3",3)), 4)

# Edit the grobs
for (i in 1:length(strip_bg_gpath)){
  g <- editGrob(grob = g, gPath = strip_bg_gpath[i], gp = gpar(fill = fills[i]))
}

grid.draw(g)
  
```


```{r eval=FALSE}
     kk <- dtagrp %>% filter(`RESULTADO` == "Positivo SARS-CoV-2") %>%
       mutate("FALLECIO" = ifelse(!is.na(`FECHA_DEF`), "Si", "No" ),
                             "TIEMPO_ATENCION" = `FECHA_INGRESO` - `FECHA_SINTOMAS`,
              "COMORB" =  paste(`DIABETES`, `EPOC`, `ASMA`, `INMUSUPR`, `HIPERTENSION`,
                                `OTRA_COM`, `CARDIOVASCULAR`, `OBESIDAD`, `RENAL_CRONICA`,
                                `TABAQUISMO`, sep="."),
              "COMORB2" = grepl("SI", `COMORB`),
              "COMORB3" = str_count(`COMORB`, "SI"))


    ## COMORBILIDADES EN INTUBADOS
    kk2 <- dta_split$Nacional %>% filter(`RESULTADO` == "Positivo SARS-CoV-2" & 
                                          `TIPO_PACIENTE` == "HOSPITALIZADO" &
                                            `INTUBADO` == "SI") %>%
            mutate("COMORB" =  paste(`DIABETES`, `EPOC`, `ASMA`, `INMUSUPR`, `HIPERTENSION`,
                                `OTRA_COM`, `CARDIOVASCULAR`, `OBESIDAD`, `RENAL_CRONICA`,
                                `TABAQUISMO`, sep="."),
              "COMORB2" = grepl("SI", `COMORB`),
              "COMORB3" = str_count(`COMORB`, "SI"))
    vec <- table(kk2$COMORB3)
    sum(vec[2:8])/sum(vec)
    
    ## No USMER y TIPO_PACIENTE
    kk2 <- dta_split$Nacional %>% filter(`RESULTADO` == "Positivo SARS-CoV-2" & 
                                          `TIPO_PACIENTE` == "HOSPITALIZADO") %>%
              summarise("DIABETES" = mean(`DIABETES` == "SI"),
                        "EPOC" = mean(`EPOC` == "SI"),
                        "ASMA" = mean(`ASMA` == "SI"),
                        "INMUSUPR" = mean(`INMUSUPR` == "SI"),
                        "HIPERTENSION" = mean(`HIPERTENSION` == "SI"),
                        "OTRA_COM" = mean(`OTRA_COM` == "SI"),
                        "CARDIOVASCULAR" = mean(`CARDIOVASCULAR` == "SI"),
                        "OBESIDAD" = mean(`OBESIDAD` == "SI"),
                        "RENAL_CRONICA" = mean(`RENAL_CRONICA` == "SI"),
                        "TABAQUISMO" = mean(`TABAQUISMO` == "SI"))
      
  
              
       
       
    
    ## PROBABILIDAD DE FALLECER DADO QUE ERES COVID POSITIVO Y TIENES 
    ## X NUMERO DE COMORBILIDADES
    table(kk$COMORB3, is.na(kk$FECHA_DEF))
    x <- c(223, 297, 238, 128 + 56 + 24 + 3 + 1 + 0 + 0 + 0)
    y <- c(4961, 2672, 1283, 469 + 144 + 30 + 10 + 1 + 1 + 2 + 1)
    x/(x+y)
    
    ## PROBABILIDAD DE SER HOSPITALIZADO DADO QUE ERES COVID POSITIVO Y TIENES 
    ## X NUMERO DE COMORBILIDADES
    table(kk$COMORB3, kk$TIPO_PACIENTE)
    x <- c(1327, 1268, 831, 365 +148 + 43 + 12 + 1 + 1 + 1 + 0)
    y <- c(3857, 1701, 690, 232 + 52 + 11 + 1 + 1 + 0 + 1 + 1)
    x/(x+y)
    
    ## PROBABILIDAD DE PRESENTAR NEUMONIA DADO QUE ERES COVID POSITIVO Y TIENES
    ## X NUMERO DE COMORBILIDADES
    table(kk$COMORB3, kk$NEUMONIA)
    x <- c(969, 987, 610, 291 + 119 + 36 + 9 + 1 + 1 + 0)
    y <- c(4215, 1982, 911, 306 + 81 + 18 + 4 + 1 + 0 + 1 + 1)
    x/(x+y)
    
    ## PROBABILIDAD DE FALLECER DADO QUE ERES COVID POSITIVO Y PRESENTAS NEUMONIA
    table(kk$COMORB3, is.na(kk$FECHA_DEF), kk$NEUMONIA)
    x <- c(166, 221, 177, 98+48+19+3+1+0+0+0)
    y <- c(803, 766, 433, 193+71+17+6+0+1+1+0)
    x/(x+y)
    
    ## PROBABILIDAD DE FALLECER DADO QUE ERES COVID POSITIVO Y ESTAS HOSPITALIZADO
    table(kk$COMORB3, is.na(kk$FECHA_DEF), kk$TIPO_PACIENTE)
    x <- c(200, 266, 220, 110+53+22+2+1+0+0+0)
    y <- c(1127, 1002, 611, 255+95+21+10+0+1+1+0)
    x/(x+y)
    
    kk2 <- kk %>% filter(`TIPO_PACIENTE` == "HOSPITALIZADO") %>%
      mutate("COMORB_NUMB" = ifelse(`COMORB3`>=3, ">=3", `COMORB3`),
             "COMORB_NUMB" = factor(`COMORB_NUMB`, levels=c("0","1", "2",">=3"))) %>%
          group_by(`COMORB_NUMB`) %>%
          summarise("Porcentaje" =  round( 100*sum(!is.na(`FECHA_DEF`))/n(),2 ))
    
   plot.kk2 <- kk2 %>% ggplot(aes(x = `COMORB_NUMB`, y=`Porcentaje`)) + 
                geom_bar(stat = "identity", fill = "darkblue") +
                  theme_bw() +
                 # theme(legend.text = element_text(size = rel(0.7)),
                #        axis.text.x = element_text(
                #                        size = rel(0.8), angle = 45)) +
                  xlab("# de comorbilidades por paciente") + 
                  ylab("% de decesos que son \n COVID-19 positivos y hospitalizados") 
    
    ## PROBABILIDAD DE SER INTUBADO DADO QUE ERES COVID POSITIVO Y ESTAS HOSPITALIZADO
    table(kk$COMORB3, kk$INTUBADO, kk$TIPO_PACIENTE)
    x <- c(135, 144, 112, 52, 19+2+1+1+0+0+0)
    y <- c(1192,1123, 719, 313, 129+41+11+0+1+1+0)
    x/(x+y)
    
    ## PROBABILIDAD DE SER INTUBADO DADO QUE ERES COVID POSITIVO Y NEUMONIA
    table(kk$COMORB3, kk$INTUBADO, kk$NEUMONIA)
    x <- c(128, 137, 107, 51, 17+2+1+1+0+0+0)
    y <- c(721,724,453,212,93+32+7+0+1+1+0)
    x/(x+y)
    
    ## PROBABILIDAD DE FALLECER DADO QUE ERES COVID POSITIVO E INTUBADO
    table(kk$COMORB3, is.na(kk$FECHA_DEF), kk$INTUBADO)
    x <- c(54, 71, 64, 25+11+2+0+1+0+0+0)
    y <- c(81,73,48,27+8+0+1+0+0+0+0)
    x/(x+y)
    
```

